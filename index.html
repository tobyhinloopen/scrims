<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<title>Scrims Balance</title>

<table class="table my-4 w-100">
  <thead>
    <tr>
      <th />
      <th colspan class="text-end">TEAM BLUE</th>
      <th id="sr1"></th>
      <th colspan class="text-end">TEAM RED</th>
      <th id="sr2"></th>
    </tr>
    <tr>
      <th style="width: 10%">ROLE</th>
      <th style="width: 15%" class="text-end">SR</th>
      <th style="width: 20%">ID</th>
      <th style="width: 15%" class="text-end">SR</th>
      <th style="width: 40%">ID</th>
    </tr>
  </thead>
  <tbody id="teams"></tbody>
</table>

<script>
const ROLES = ["Main Tank", "Off Tank", "Hitscan DPS", "Flex DPS", "Main Support", "Flex Support"]

// ROLES: Main Tank, Off Tank, Hitscan, Flex DPS, Main Support, Flex Support
const PLAYERS = [
  {name: 'elark#2601', tank: 2500, dps: 2750, supp: 3500, roles: "012212"},
  {name: 'gamebuster#21298', tank: 2300, dps: 2100, supp: 2000, roles: "021212"},
  {name: 'Valfreyja#2252', tank: 1584, dps: 1592, supp: 1891, roles: "000021"},
  {name: 'BornInPurple#1395', tank: 2250, dps: 1750, supp: 2992, roles: "112200"},
  {name: 'Prekaza#1965', tank: 2620, dps: 2731, supp: 3225, roles: "022012"},
  {name: 'becky1360#2293', tank: 2159, dps: 1683, supp: 1771, roles: "120112", comment: "Prefers not to play but is available to fill"},
  {name: 'Mashiro#12790', tank: 2250, dps: 2750, supp: 2250, roles: "111111"},
  {name: 'Mercrazzle#2687', tank: 2350, dps: 1750, supp: 2100, roles: "111111"},
  {name: 'CodexMortem#1370', tank: 2604, dps: 2344, supp: 2319, roles: "122101"},
  {name: 'Maniclings#6606', tank: 2250, dps: 2250, supp: 2700, roles: "000040", comment: "Prefers not to play but is available to fill"},
  {name: 'ForsenCalls#1771', tank: 3000, dps: 3500, supp: 2900, roles: "122210"},
  {name: 'Broseidon#11439', tank: 3038, dps: 3108, supp: 3687, roles: "011022"},
  {name: 'Tomjo5#1129', tank: 3335, dps: 2250, supp: 2561, roles: "020200"},
];

const ROLE_WEIGHT = [-3, 1, 3]

function roleScore(roles, slot) {
  const exactRole = ROLE_WEIGHT[roles[slot]] * 3;
  const altRole = ROLE_WEIGHT[roles[(slot / 2)|0 + (1 - slot % 2)]|0];
  const max = Math.max(exactRole, altRole);
  return max == 0 ? -10 : max;
}

const teamPairs = _.sortBy(
  _.times(100, () => createRandomTeamPair()),
  (teamPair) => -getTeamPairScore(teamPair));

const [TEAM_BLUE, TEAM_RED] = teamPairs[0];

function teamSr(team) {
  return team
    .map((player, index) => playerSr(player, index))
    .reduce((sum, sr) => sum + sr, 0) / team.length;
}

function createRandomTeamPair() {
  return _.zip(..._(PLAYERS)
    .shuffle()
    .slice(0, 12)
    // .sortBy((player) => player.tank + player.dps + player.dps)
    .chunk(2)
    .map((pair) => _.shuffle(pair))
    .toJSON());
}

function teamRoleScore(team) {
  return _.sum(_.map(team, (player, index) => roleScore(player.roles, index)));
}

function getTeamPairScore(teamPair) {
  const [a, b] = teamPair;

  const roleScoreSum = teamRoleScore(a) + teamRoleScore(b);

  const teamSrA = teamSr(a);
  const teamSrB = teamSr(b);
  const srDiff = Math.abs(teamSrA - teamSrB);

  return (0 - srDiff) + roleScoreSum * 10;
}

function renderPlayerHtml(player, roleIndex) {
  if (!player) {
    return `<td></td><td></td>`;
  }
  const sr = playerSr(player, roleIndex);
  return `<td class="text-end">${sr}</td><td>${player.name.replace(/#\d+$/, "")}</td>`;
}

function playerSr(player, roleIndex) {
  return player ? [player.tank, player.dps, player.supp][Math.floor(roleIndex / 2)] : 0;
}

const tbody = document.querySelector("#teams");
for (let i = 0; i < 6; i++) {
  const tr = document.createElement("tr");
  tr.innerHTML = `<th>${ROLES[i]}</th>` + renderPlayerHtml(TEAM_BLUE[i], i) + renderPlayerHtml(TEAM_RED[i], i);
  tbody.appendChild(tr);
}

console.log(getTeamPairScore([TEAM_BLUE, TEAM_RED]))

document.querySelector("#sr1").textContent = `avg ${teamSr(TEAM_BLUE).toFixed(0)}`;
document.querySelector("#sr2").textContent = `avg ${teamSr(TEAM_RED).toFixed(0)}`;
</script>
